<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meeting Summarizer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>AI Meeting Summarizer</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'uploadTab')">Upload Audio File</button>
            <button class="tab-button" onclick="openTab(event, 'recordTab')">Record Live Meeting</button>
        </div>

        <!-- Upload Audio File Tab -->
        <div id="uploadTab" class="tab-content" style="display:block;">
            <h2>Upload New Meeting Audio</h2>
            <form method="POST" action="{{ url_for('index') }}" enctype="multipart/form-data" id="uploadForm">
                <input type="file" name="audio_file" accept=".mp3,.wav,.m4a,.mp4,.ogg,.flac,.webm" required>
                <button type="submit" id="uploadButton">Upload and Process</button>
                <span id="uploadLoadingSpinner" class="loading-spinner" style="display:none;">
                    <img src="https://i.gifer.com/ZZ5H.gif" alt="Loading..." width="30" height="30"> Processing...
                </span>
            </form>
            <p><small>Supported formats: mp3, wav, m4a, mp4, ogg, flac, webm. Max size: 100MB.</small></p>
            <p><small>Processing can take time, especially for long audio files. Please be patient.</small></p>
        </div>

        <!-- Record Live Meeting Tab -->
        <div id="recordTab" class="tab-content" style="display:none;">
            <h2>Record Live Meeting</h2>
            <div id="recorderControls">
                <button id="startButton" class="button-record">Start Recording</button>
                <button id="stopButton" class="button-stop" disabled>Stop Recording</button>
                <button id="processRecordingButton" class="button-process" disabled>Process Recording</button>
                <span id="timer" style="margin-left: 10px;">00:00</span>
                 <span id="recordLoadingSpinner" class="loading-spinner" style="display:none;">
                    <img src="https://i.gifer.com/ZZ5H.gif" alt="Loading..." width="30" height="30"> Processing...
                </span>
            </div>
            <div id="recordingStatus" style="margin-top:10px;">Status: Idle</div>
            <audio id="audioPlayback" controls style="display:none; margin-top:10px; width:100%;"></audio>
            <p id="recordingError" class="error-message" style="color:red;"></p>
            
            <!-- Div to show processing results -->
            <div id="liveMeetingResults" style="display:none; margin-top: 20px;">
                <h3>Processing Results:</h3>
                <p><a href="#" id="fullMeetingDetailsLink" class="button" target="_blank">View Full Meeting Details Page</a></p>
                
                <div class="section">
                    <h4>Summary:</h4>
                    <p id="liveSummary" class="preserve-whitespace">Loading...</p>
                </div>
                <div class="section">
                    <h4>Action Items:</h4>
                    <div id="liveActionItems">Loading...</div>
                </div>
                <div class="section">
                    <h4>Decisions:</h4>
                    <div id="liveDecisions">Loading...</div>
                </div>
            </div>

            <p><small>Ensure your microphone is enabled and permissions are granted.</small></p>
            <p><small>When finished, click "Stop Recording", then "Process Recording". Results will appear above.</small></p>
        </div>


        <h2>Processed Meetings</h2>
        <!-- ... (Processed Meetings Table - same as before) ... -->
        {% if meetings %}
        <table>
            <thead>
                <tr>
                    <th>Filename/Title</th>
                    <th>Uploaded/Recorded At</th>
                    <th>Status</th>
                    <th>Summary Snippet</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for meeting in meetings %}
                <tr>
                    <td>{{ meeting.filename }}</td>
                    <td>{{ meeting.upload_time.strftime('%Y-%m-%d %H:%M') if meeting.upload_time else 'N/A' }}</td>
                    <td>
                        <span class="status status-{{ meeting.processing_status.replace(' ', '-') | lower }}">{{ meeting.processing_status }}</span>
                    </td>
                    <td>{{ (meeting.summary[:100] + '...') if meeting.summary and meeting.summary|length > 100 else meeting.summary }}</td>
                    <td>
                        {% if meeting.processing_status == 'completed' %}
                            <a href="{{ url_for('meeting_detail', meeting_id=meeting.id) }}" class="button">View Details</a>
                        {% elif meeting.processing_status == 'error' and meeting.summary and 'Transcription failed.' not in meeting.summary and 'Processing Error:' not in meeting.summary and 'OpenAI' not in meeting.summary %}
                            <a href="{{ url_for('meeting_detail', meeting_id=meeting.id) }}" class="button">View Details (Partial)</a>
                        {% elif meeting.processing_status == 'error' %}
                             <a href="{{ url_for('meeting_detail', meeting_id=meeting.id) }}" class="button button-info">View Error</a>
                        {% else %}
                            <span class="status status-{{ meeting.processing_status.replace(' ', '-') | lower }}">Processing...</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No meetings processed yet.</p>
        {% endif %}
    </div>

<script>
    // Tab functionality (same as before)
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // Upload form spinner (same as before)
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function() {
            document.getElementById('uploadButton').style.display = 'none';
            document.getElementById('uploadLoadingSpinner').style.display = 'inline-block';
        });
    }

    // Recorder functionality
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const processRecordingButton = document.getElementById('processRecordingButton');
    const audioPlayback = document.getElementById('audioPlayback');
    const recordingStatus = document.getElementById('recordingStatus');
    const recordingError = document.getElementById('recordingError');
    const timerDisplay = document.getElementById('timer');
    const recordLoadingSpinner = document.getElementById('recordLoadingSpinner');

    const liveMeetingResultsDiv = document.getElementById('liveMeetingResults');
    const fullMeetingDetailsLink = document.getElementById('fullMeetingDetailsLink');
    const liveSummaryP = document.getElementById('liveSummary');
    const liveActionItemsDiv = document.getElementById('liveActionItems');
    const liveDecisionsDiv = document.getElementById('liveDecisions');

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let timerInterval;
    let secondsElapsed = 0;

    function resetLiveResults() {
        liveMeetingResultsDiv.style.display = 'none';
        liveSummaryP.textContent = 'Loading...';
        liveActionItemsDiv.innerHTML = 'Loading...'; // Use innerHTML if adding HTML table/list
        liveDecisionsDiv.innerHTML = 'Loading...';
        fullMeetingDetailsLink.href = "#";
    }

    if (startButton) { 
        startButton.onclick = async () => {
            recordingError.textContent = '';
            resetLiveResults(); // Clear previous results
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); // Specify MIME type

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;
                    audioPlayback.style.display = 'block';
                    processRecordingButton.disabled = false;
                    recordingStatus.textContent = 'Status: Recording stopped. Ready to process or re-record.';
                    audioChunks = []; 
                    stopTimer();
                };

                mediaRecorder.start();
                recordingStatus.textContent = 'Status: Recording...';
                startButton.disabled = true;
                stopButton.disabled = false;
                processRecordingButton.disabled = true;
                audioPlayback.style.display = 'none';
                startTimer();

            } catch (err) {
                console.error("Error accessing microphone:", err);
                recordingStatus.textContent = 'Status: Error accessing microphone.';
                recordingError.textContent = 'Could not access microphone. Please ensure permission is granted. Error: ' + err.name + ": " + err.message;
                startButton.disabled = false;
                stopButton.disabled = true;
                processRecordingButton.disabled = true;
            }
        };

        stopButton.onclick = () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        };

        processRecordingButton.onclick = async () => {
            if (!audioBlob) {
                recordingError.textContent = 'No recording available to process.';
                return;
            }
            resetLiveResults(); // Clear previous results before showing new ones
            processRecordingButton.disabled = true;
            startButton.disabled = true;
            stopButton.disabled = true;
            recordLoadingSpinner.style.display = 'inline-block';
            recordingStatus.textContent = 'Status: Processing recording... This may take a moment.';
            liveMeetingResultsDiv.style.display = 'block'; // Show results area

            const formData = new FormData();
            const timestamp = new Date().toISOString().replace(/[-:.]/g, "").slice(0, -4);
            const recordingFilename = `live_recording_${timestamp}.webm`; // Ensure server expects .webm
            formData.append('audio_file', audioBlob, recordingFilename);

            try {
                const response = await fetch("{{ url_for('process_recorded_audio') }}", {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json(); // Always try to parse JSON

                if (response.ok && result.status === 'success') {
                    recordingStatus.textContent = 'Status: Processing complete!';
                    fullMeetingDetailsLink.href = result.redirect_url;
                    
                    liveSummaryP.textContent = result.summary || "Summary not available.";
                    if (result.summary && result.summary.startsWith("ERROR:")) {
                        liveSummaryP.classList.add("error-message");
                    } else {
                        liveSummaryP.classList.remove("error-message");
                    }

                    // Display Action Items
                    if (result.action_items && result.action_items.length > 0) {
                        let aiHtml = '<table><thead><tr><th>Task</th><th>Owner</th><th>Due Date</th></tr></thead><tbody>';
                        result.action_items.forEach(item => {
                            aiHtml += `<tr><td>${item.task || 'N/A'}</td><td>${item.owner || 'N/A'}</td><td>${item.due_date || 'N/A'}</td></tr>`;
                        });
                        aiHtml += '</tbody></table>';
                        liveActionItemsDiv.innerHTML = aiHtml;
                    } else {
                        liveActionItemsDiv.innerHTML = '<p>No action items identified or an error occurred.</p>';
                    }

                    // Display Decisions
                    if (result.decisions && result.decisions.length > 0) {
                        let dHtml = '<ul>';
                        result.decisions.forEach(decision => {
                            dHtml += `<li>${decision}</li>`;
                        });
                        dHtml += '</ul>';
                        liveDecisionsDiv.innerHTML = dHtml;
                    } else {
                        liveDecisionsDiv.innerHTML = '<p>No decisions identified or an error occurred.</p>';
                    }
                     // Optionally, refresh the main meetings list if desired, or instruct user to refresh page for that.
                     // For now, we show results here and they can click the link for full details / .ics etc.

                } else {
                    recordingError.textContent = 'Error processing recording: ' + (result.message || `Server error ${response.status}.`);
                    recordingStatus.textContent = 'Status: Processing failed.';
                    liveSummaryP.textContent = (result.message || `Server error ${response.status}.`);
                    liveSummaryP.classList.add("error-message");
                    liveActionItemsDiv.innerHTML = '<p>Could not retrieve action items.</p>';
                    liveDecisionsDiv.innerHTML = '<p>Could not retrieve decisions.</p>';
                }
            } catch (err) {
                console.error('Error during fetch or JSON parsing:', err);
                recordingError.textContent = 'Network error or invalid server response.';
                recordingStatus.textContent = 'Status: Processing failed.';
                liveSummaryP.textContent = 'Network error or invalid server response.';
                liveSummaryP.classList.add("error-message");
            } finally {
                recordLoadingSpinner.style.display = 'none';
                startButton.disabled = false; 
                // Keep process button disabled until a new recording is made or if audioBlob is still valid
                processRecordingButton.disabled = (audioBlob === null); 
            }
        };
    }

    function startTimer() { /* ... same as before ... */ 
        secondsElapsed = 0;
        timerDisplay.textContent = formatTime(secondsElapsed);
        timerInterval = setInterval(() => {
            secondsElapsed++;
            timerDisplay.textContent = formatTime(secondsElapsed);
        }, 1000);
    }
    function stopTimer() { /* ... same as before ... */ 
        clearInterval(timerInterval);
    }
    function formatTime(totalSeconds) { /* ... same as before ... */ 
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
</script>
</body>
</html>